name: Daily Census Report Generation

on:
  schedule:
    # Run at 00:00 UTC every day (midnight UTC)
    # This is 03:00 Athens time during summer (UTC+3)
    # and 02:00 Athens time during winter (UTC+2)
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-report:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create .env.local file
        run: |
          echo "ETORO_API_KEY=${{ secrets.ETORO_API_KEY }}" > .env.local
          echo "ETORO_USER_KEY=${{ secrets.ETORO_USER_KEY }}" >> .env.local
          # Verify the file was created
          echo "Created .env.local with:"
          wc -l .env.local
          
      - name: Build Next.js application
        run: npm run build
      
      - name: Start Next.js server
        run: |
          npm start &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          # Wait for server to be ready
          sleep 10
          # Check if server is running
          curl -f http://localhost:3000 || exit 1
      
      - name: Generate census report
        run: |
          # Call the generate report endpoint
          curl -X POST http://localhost:3000/api/generate-report \
            -H "Content-Type: application/json" \
            -d '{"period": "CurrYear"}' \
            --no-buffer \
            --silent \
            --show-error \
            --fail-with-body \
            -w "\n\nHTTP Status: %{http_code}\n" | while IFS= read -r line; do
              echo "$line"
              # Check if this is the complete event with the report URL
              if echo "$line" | grep -q '"type":"complete"'; then
                # Extract the URL from the JSON
                URL=$(echo "$line" | sed -n 's/.*"url":"\([^"]*\)".*/\1/p')
                echo "Report generated at: $URL"
              fi
            done
      
      - name: Stop Next.js server
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
      
      - name: Commit and push reports
        run: |
          git add public/reports/*.html docs/index.html data/daily/*.json
          git diff --staged --quiet || {
            COMMIT_MSG="Daily census report - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git commit -m "$COMMIT_MSG"
            git push
          }
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public/reports'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4